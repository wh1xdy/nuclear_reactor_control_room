name: build-macos

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-app:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-13
            arch: x86_64
          - os: macos-14
            arch: arm64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build deps
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -e .

      - name: Build .app with PyInstaller
        run: |
          pyinstaller --noconfirm --windowed \
            --name "NuclearReactorControlRoom" \
            --collect-all pygame \
            run_control_room.py

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: NRCR-app-${{ matrix.arch }}
          path: dist/NuclearReactorControlRoom.app

  build-universal-dmg:
    runs-on: macos-14
    needs: build-app

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install merge + DMG deps
        run: |
          python -m pip install --upgrade pip
          pip install dmgbuild

      - name: Download arm64 app
        uses: actions/download-artifact@v4
        with:
          name: NRCR-app-arm64
          path: artifacts/arm64

      - name: Download x86_64 app
        uses: actions/download-artifact@v4
        with:
          name: NRCR-app-x86_64
          path: artifacts/x86_64

      - name: Create universal app bundle
        run: |
          python - <<'PY'
          from pathlib import Path
          import shutil
          import subprocess

          arm_app = Path('artifacts/arm64/NuclearReactorControlRoom.app')
          x64_app = Path('artifacts/x86_64/NuclearReactorControlRoom.app')
          out_app = Path('dist/NuclearReactorControlRoom.app')

          if out_app.exists():
              shutil.rmtree(out_app)

          shutil.copytree(arm_app, out_app)

          def is_macho(path: Path) -> bool:
              proc = subprocess.run(['file', '-b', str(path)], capture_output=True, text=True, check=True)
              return 'Mach-O' in proc.stdout

          for src in x64_app.rglob('*'):
              rel = src.relative_to(x64_app)
              dst = out_app / rel

              if src.is_dir():
                  dst.mkdir(parents=True, exist_ok=True)
                  continue

              if not dst.exists():
                  dst.parent.mkdir(parents=True, exist_ok=True)
                  shutil.copy2(src, dst)
                  continue

              if is_macho(src) and is_macho(dst):
                  tmp = dst.with_suffix(dst.suffix + '.universal')
                  subprocess.run(['lipo', '-create', str(dst), str(src), '-output', str(tmp)], check=True)
                  tmp.replace(dst)

          subprocess.run(['lipo', '-info', str(out_app / 'Contents/MacOS/NuclearReactorControlRoom')], check=True)
          print('Universal app created:', out_app)
          PY

      - name: Build universal DMG
        run: |
          python - <<'PY'
          import os
          import dmgbuild

          app = 'dist/NuclearReactorControlRoom.app'
          assert os.path.isdir(app), f"Missing {app}"

          settings = {
              'volume_name': 'NRCR-universal',
              'format': 'UDZO',
              'files': [app],
              'symlinks': {'Applications': '/Applications'},
              'icon_locations': {'NuclearReactorControlRoom.app': (140, 120), 'Applications': (420, 120)},
              'window_rect': ((200, 200), (600, 320)),
              'default_view': 'icon-view',
          }

          dmgbuild.build_dmg(
              filename='dist/NRCR-universal.dmg',
              volume_name=settings['volume_name'],
              settings=settings,
          )
          print('Universal DMG built')
          PY

      - name: Upload universal DMG
        uses: actions/upload-artifact@v4
        with:
          name: NRCR-universal
          path: dist/NRCR-universal.dmg
